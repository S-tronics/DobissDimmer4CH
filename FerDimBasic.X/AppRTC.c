/**********************************************************************************************************************/
/**
 * @file        AppRTC.c
 *
 * @author      Stijn Vermeersch
 * @date        05.07.2022
 *
 * @brief       
 *
 *
 * \n<hr>
 * Copyright (c) 2022, S-tronics BV\n
 * All rights reserved.
 * \n<hr>\n
 */
/**********************************************************************************************************************/

/**********************************************************************************************************************/



/***********************************************************************************************************************
; V E R I F Y    C O N F I G U R A T I O N
;---------------------------------------------------------------------------------------------------------------------*/

/*--------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/



/***********************************************************************************************************************
; I N C L U D E S
;---------------------------------------------------------------------------------------------------------------------*/

//Only for debug reasons

//DRIVER lib include section

//STANDARD lib include section
//APPLICATION lib include section
#include "AppRTC.h"
#include "AppDimmer.h"
#include "AppLed.h"
#include "AppCan.h"
#include "AppAction.h"
#include "AppConfig.h"
/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   D E F I N I T I O N S   A N D   M A C R O S
;---------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   T Y P E D E F S
;---------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   F U N C T I O N   P R O T O T Y P E S
;---------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   V A R I A B L E S
;---------------------------------------------------------------------------------------------------------------------*/


/**********************************************************************************************************************/



/***********************************************************************************************************************
; E X P O R T E D   V A R I A B L E S
;---------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   F U N C T I O N S
;---------------------------------------------------------------------------------------------------------------------*/

/*--------------------------------------------------------------------------------------------------------------------*/

/*--------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/



/***********************************************************************************************************************
; E X P O R T E D   F U N C T I O N S
;---------------------------------------------------------------------------------------------------------------------*/
void AppRTCInit(void)
{

}
/*--------------------------------------------------------------------------------------------------------------------*/
void AppRTCSeconds(void)
{
    unsigned char i;

    // <editor-fold defaultstate="collapsed" desc="Tool Scan method">
    if (module.toolScan && module.toolTimer)
    {
        module.toolTimer--;
        if (!module.toolTimer)
        {
            module.toolScan = 0;
        }
        return;
    }
    if (module.toolWait && module.toolTimer)
    {
        module.toolTimer--;
        if (!module.toolTimer)
        {
            module.toolWait = 0;
            AppLEDControl(POWER, true, RED);
        }
        return;
    }
    // </editor-fold>

    // <editor-fold defaultstate="collapsed" desc="Seconds checker">
    for (i=0; i<NBROFCHANNELS; i++)         // sec passed --> check if there are Seconds actions
    {
        // <editor-fold defaultstate="collapsed" desc="FlickerTest">
        // Check if CMD.Purp.flick is running and if the flicksec is counting down (avoid illegal value of 0xFF)
        if (cmd[i].Purp.flick && rtccount[i].flicksec && rtccount[i].flicksec != 0xFF)
        {
            rtccount[i].flicksec--;
            if (!rtccount[i].flicksec)
            {
                if (dim_ch[i].actValue == 0)
                {
                    dim_ch[i].actValue = 100;
                    dim_ch[i].moving = NO;                                         // NOT moving
                    dim_ch[i].tStart = 0;
                    dim_ch[i].tUp = 0;
                    dim_ch[i].speed = 0;
                }
                else
                {
                    dim_ch[i].actValue = 0;
                    dim_ch[i].moving = NO;                                         // NOT moving
                    dim_ch[i].tJump = 0;
                    dim_ch[i].tDown = 0;
                    dim_ch[i].speed = 0;
                }
                AppDimmerUpdate();
                AppCanSendStatusUpdate(i, dim_ch[i].actValue);
                if (cmd[i].action.delayOn.all != 0xFF) {
                    // Make sure the value is valid (0xFF can never be configured from the software)
                    cmd[i].Purp.flick = 1; // Make sure the CMD.Purp.flick is also correctly set
                    rtccount[i].flicksec = cmd[i].action.delayOn.delay;
                }
            }
        }
        // </editor-fold>

        if (rtccount[i].sec)
        {
            rtccount[i].sec--;
            if (!rtccount[i].sec)
            {
                // <editor-fold defaultstate="collapsed" desc="Flicker END">
                if (cmd[i].Purp.flick)                                          // uitgang was aan het flikkeren --> nu stoppen
                {
                    dim_ch[i].actValue = rtccount[i].oldstatus;
                    dim_ch[i].moving = NO;
                    dim_ch[i].tStart = 0;
                    dim_ch[i].tUp = 0;
                    dim_ch[i].tJump = 0;
                    dim_ch[i].tDown = 0;
                    dim_ch[i].speed = 0;
                    cmd[i].Purp.flick = 0;
                    rtccount[i].flicksec = 0;
                    AppDimmerUpdate();
                    AppCanSendStatusUpdate(i, dim_ch[i].actValue);
                }
                // </editor-fold>

                else if (cmd[i].action.delayOn.all != 0xFF)                            // Set now Output ON
                {
                    cmd[i].action.delayOn.all = 0xFF;
                    AppActionSetOn(i);
                }
                else if (cmd[i].action.delayOff.all != 0xFF)                           // Set now Output OFF
                {
                    cmd[i].action.delayOff.all = 0xFF;
                    AppActionSetOff(i);
                }
            }
        }
    }
    // </editor-fold>

    // <editor-fold defaultstate="collapsed" desc="Minutes checker">
    if (RTCminutes) RTCminutes--;
    if (RTCminutes == 0)            // minute passed --> check if there are Minutes actions
    {
        for (i=0; i<NBROFCHANNELS; i++)
        {
            if (rtccount[i].min)
            {
                rtccount[i].min--;
                if (!rtccount[i].min)
                {
                    // <editor-fold defaultstate="collapsed" desc="Flicker END">
                    if (cmd[i].Purp.flick)                                      // uitgang was aan het flikkeren --> nu stoppen
                    {
                        dim_ch[i].actValue = rtccount[i].oldstatus;
                        dim_ch[i].moving = NO;
                        dim_ch[i].tStart = 0;
                        dim_ch[i].tUp = 0;
                        dim_ch[i].tJump = 0;
                        dim_ch[i].tDown = 0;
                        dim_ch[i].speed = 0;
                        cmd[i].Purp.flick = 0;
                        rtccount[i].flicksec = 0;
                        AppDimmerUpdate();
                    }
                    // </editor-fold>

                    else if (cmd[i].action.delayOn.all != 0xFF)                        // Set now Output ON
                    {
                        cmd[i].action.delayOn.all = 0xFF;
                        AppActionSetOn(i);
                    }
                    else if (cmd[i].action.delayOff.all != 0xFF)                       // Set now Output OFF
                    {
                        cmd[i].action.delayOff.all = 0xFF;
                        AppActionSetOff(i);
                    }
                }
            }
        }
        RTCminutes = 60;
    }
    // </editor-fold>
}
/*--------------------------------------------------------------------------------------------------------------------*/

/*--------------------------------------------------------------------------------------------------------------------*/

/*--------------------------------------------------------------------------------------------------------------------*/

/*--------------------------------------------------------------------------------------------------------------------*/

/*--------------------------------------------------------------------------------------------------------------------*/

/*--------------------------------------------------------------------------------------------------------------------*/

/*--------------------------------------------------------------------------------------------------------------------*/

/*--------------------------------------------------------------------------------------------------------------------*/

/*--------------------------------------------------------------------------------------------------------------------*/

/*--------------------------------------------------------------------------------------------------------------------*/

/*--------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/
