/**********************************************************************************************************************/
/**
 * @file        adc\DrvAdc.c
 *
 * @author      Stijn Vermeersch
 * @date        02.01.2017
 *
 * @brief       Basic ADC manipulation functionality
 *
 * This ADC manipulating module is designed to be used for initialisation and modifying ADC ports and pins.\n
 *
 * \n<hr>\n
 * Copyright (c) 2017, S-tronics\n
 * All rights reserved.
 * \n<hr>\n
 */
/**********************************************************************************************************************/
#define ADC__DRVADC_C
/**********************************************************************************************************************/



/***********************************************************************************************************************
; V E R I F Y    C O N F I G U R A T I O N
;---------------------------------------------------------------------------------------------------------------------*/
//#include "AppConfig.h"

// /**
 // * @brief  Defines the Processortype used for this code
 // *
 // * The processortype defines how to read out an ADC-value
 // *
 // */
// #ifndef PIC18F2X-4XK22
	 // #error "Processortype not defined in AppConfig.h"
// #endif 
// /**
 // * @brief  Defines the number of ADC channels to be registered
 // */
// #ifndef NR_OF_ADC_CHS
    // #error "NR_OF_ADC_CHS not defined in AppConfig.h"
// #endif
// /**
 // * @brief  Defines the interrupt priority of the ADC channel when a AD-conversion is done
 // */
// #ifndef DRVADC_ADC_CONV_DONE_INT_PRIOR
	// #error "DRVADC_ADC_CONV_DONE_INT_PRIOR not defined in AppConfig.h"
// #endif
/**********************************************************************************************************************/



/***********************************************************************************************************************
; I N C L U D E S
;---------------------------------------------------------------------------------------------------------------------*/
#include "..\..\System\PIC18F2X\SysLibAll.h"

//DRIVER lib include section
#include "DrvAdc.h"
/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   D E F I N I T I O N S   A N D   M A C R O S
;---------------------------------------------------------------------------------------------------------------------*/
#define  ADC_DONE	0x02
/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   T Y P E D E F S
;---------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   F U N C T I O N   P R O T O T Y P E S
;---------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   V A R I A B L E S
;---------------------------------------------------------------------------------------------------------------------*/
BOOLEAN     conversiondone = FALSE;
UNSIGNED_16 adcresult = 0;
//static ADC_CHANNEL									adc_channel_result[NR_OF_ADC_CHS];
//HOOK_ADC_CONVERSION_DONE							adc_conv_done_hook;
/**********************************************************************************************************************/



/***********************************************************************************************************************
; E X P O R T E D   V A R I A B L E S
;---------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   F U N C T I O N S
;---------------------------------------------------------------------------------------------------------------------*/
/**********************************************************************************************************************/



/***********************************************************************************************************************
; E X P O R T E D   F U N C T I O N S
;---------------------------------------------------------------------------------------------------------------------*/
void DrvAdcInit(void)
{
    //TODO make this configurable
	ADCON1 &= 0xF0;		//Connect Vref+ to AVdd; connect Vref- to AVss
	ADCON2 &= 0xC7;		//
    ADCON2 |= 0x38;     //A/D conversion time 20 * TAD
	ADCON2 |= 0x06;		//A/D Conversion Clock Fosc/64
    ADCON2 |= 0x80;     //ADC-value right justified
	
}
/*--------------------------------------------------------------------------------------------------------------------*/
void DrvAdcInitChannel(ADC_PIN_NAME pin_name)
{
	switch (pin_name)
	{
		case ADC_AN0:
			ANSELA |= 0x01;
			TRISA |= 0x01;
			break;
		case ADC_AN1:
			ANSELA |= 0x02;
			TRISA |= 0x02;
			break;
		case ADC_AN2:
			ANSELA |= 0x04;
			TRISA |= 0x04;
			break;
		case ADC_AN3:
			ANSELA |= 0x08;
			TRISA |= 0x08;
			break;
		case ADC_AN4:
			ANSELA |= 0x20;
			TRISA |= 0x20;
			break;
		case ADC_AN8:
			ANSELB |= 0x04;
			TRISB |= 0x04;
			break;
		case ADC_AN9:
			ANSELB |= 0x08;
			TRISB |= 0x08;
			break;
		case ADC_AN10:
			ANSELB |= 0x02;
			TRISB |= 0x02;
			break;
		case ADC_AN11:
			ANSELB |= 0x10;
			TRISB |= 0x10;
			break;
		case ADC_AN12:
			ANSELB |= 0x01;
			TRISB |= 0x01;
			break;
		case ADC_AN13:
			ANSELB |= 0x20;
			TRISB |= 0x20;
			break;
		case ADC_AN14:
			ANSELC |= 0x04;
			TRISC |= 0x04;
			break;
		case ADC_AN15:
			ANSELC |= 0x08;
			TRISC |= 0x08;
			break;
		case ADC_AN16:
			ANSELC |= 0x10;
			TRISC |= 0x10;
			break;
		case ADC_AN17:
			ANSELC |= 0x20;
			TRISC |= 0x20;
			break;
		case ADC_AN18:
			ANSELC |= 0x40;
			TRISC |= 0x40;
			break;
		case ADC_AN19:
			ANSELC |= 0x80;
			TRISC |= 0x80;
			break;
		default:
			break;
	}
}
/*--------------------------------------------------------------------------------------------------------------------*/
BOOLEAN DrvAdcStartConversion(ADC_PIN_NAME pin_name)
{
	conversiondone = FALSE;
    ADCON0 &= 0x83;      //Clear Channel Select Bits
	ADCON0 |= (((UNSIGNED_8)(pin_name)) << 2);
	ADCON0 |= 0x01;		//Enable ADC
    ADCON0 |= 0x02;     //Start Conversion
	
	return TRUE;
}
/*--------------------------------------------------------------------------------------------------------------------*/
BOOLEAN DrvAdcConversionDone(void)
{
	if((ADCON0 & 0x02) == 0x02)
	{
		//Conversion in progress
        conversiondone = FALSE;
		return FALSE;
	}
	else
	{
        conversiondone = TRUE;
		return TRUE;
	}
}
/*--------------------------------------------------------------------------------------------------------------------*/
void DrvAdcIsrConversionDone(void)
{
    conversiondone = TRUE;
    adcresult = ((ADRESH & 0x03)<<8) | ADRESL;
}
/*--------------------------------------------------------------------------------------------------------------------*/
UNSIGNED_16 DrvAdcGetResult(void)
{
	UNSIGNED_16 result = 0x0000;
    
    if(conversiondone == TRUE)
    {
        result = ((ADRESH & 0x03)<<8) | ADRESL;
    }
    else
    {
        result = 0;
    }
    return result;
}
/*--------------------------------------------------------------------------------------------------------------------*/
 UNSIGNED_16 DrvAdcGetResultOfInt(void)
 {

     return adcresult;
 }
/*--------------------------------------------------------------------------------------------------------------------*/
// void DrvAdcIntEnable(void)
// {
	
// }
// /*--------------------------------------------------------------------------------------------------------------------*/
// void DrvAdcIntDisable(void)
// {

// }
// /*--------------------------------------------------------------------------------------------------------------------*/
// void DrvAdcConversionDoneIsr(void)
// {

// }
// /*--------------------------------------------------------------------------------------------------------------------*/
// BOOLEAN DrvAdcRegisterConvDoneHandler(ADC_PIN_NAME ch, HOOK_ADC_CONVERSION_DONE hook_adc_conv_done)
// {

// }
/**********************************************************************************************************************/
