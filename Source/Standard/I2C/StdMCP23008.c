/**********************************************************************************************************************/
/**
 * @file        StdMCP28003.c
 *
 * @author      Stijn Vermeersch
 * @date        01.12.2020
 *
 * @brief       
 *
 *
 * \n<hr>\n
 * Copyright (c) 2020, S-tronics\n
 * All rights reserved.
 * \n<hr>\n
 */
/**********************************************************************************************************************/
#define STDMCP28003_C
/**********************************************************************************************************************/



/***********************************************************************************************************************
; V E R I F Y    C O N F I G U R A T I O N
;---------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/



/***********************************************************************************************************************
; I N C L U D E S
;---------------------------------------------------------------------------------------------------------------------*/
#include "..\..\System\PIC18F2X\SysLibAll.h"
//DRIVER lib include section
#include "..\..\Driver\PIC18F2X\DrvI2C.h"
//STANDARD lib include section
#include "StdMCP23008.h"
/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   D E F I N I T I O N S   A N D   M A C R O S
;---------------------------------------------------------------------------------------------------------------------*/
/* MCP23008 I2C ADDRESS*/
#define MCP23008        0x20
/* Register Addresses */
#define REG_IODIR       0x00
#define REG_IPOL        0x01
#define REG_GPINTEN     0x02
#define REG_DEFVAL      0x03
#define REG_INTCON      0x04
#define REG_IOCON       0x05
#define REG_GPPU        0x06
#define REG_INTF        0x07
#define REG_INTCAP      0x08
#define REG_GPIO        0x09
#define REG_OLAT        0x0A

/**********************************************************************************************************************/


/***********************************************************************************************************************
; L O C A L   T Y P E D E F S
;---------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   F U N C T I O N   P R O T O T Y P E S
;---------------------------------------------------------------------------------------------------------------------*/
void StdMCP23008ReadCmd(UNSIGNED_8* reg, UNSIGNED_8* data);
void StdMCP23008WriteCmd(UNSIGNED_8* reg, UNSIGNED_8* data);
/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   V A R I A B L E S
;---------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/



/***********************************************************************************************************************
; E X P O R T E D   V A R I A B L E S
;---------------------------------------------------------------------------------------------------------------------*/
static DRVI2C_DEV_HNDL 	hndl;
static UNSIGNED_8 reg;
static UNSIGNED_8 data;
static MCP_GPIO ar_ch[8];
/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   F U N C T I O N S
;---------------------------------------------------------------------------------------------------------------------*/
void StdMCP23008ReadCmd(UNSIGNED_8* reg, UNSIGNED_8* data)
{
    DrvI2CBeginTransmission(hndl,I2C_W);
    DrvI2CWriteMstr(hndl, reg);
    DrvI2CRepeatedStart(hndl);
	DrvI2CWriteAddrMstr(hndl, I2C_R);
	DrvI2CReadMstr(hndl, data, TRUE);
    DrvI2CStop(hndl);
}
/*--------------------------------------------------------------------------------------------------------------------*/
void StdMCP23008WriteCmd(UNSIGNED_8* reg, UNSIGNED_8* data)
{
    DrvI2CBeginTransmission(hndl,I2C_W);
    DrvI2CWriteMstr(hndl, reg);
    DrvI2CWriteMstr(hndl, data);
    DrvI2CStop(hndl);
}
/*--------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/



/***********************************************************************************************************************
; E X P O R T E D   F U N C T I O N S
;---------------------------------------------------------------------------------------------------------------------*/
void StdMCP23008Init(GPIO_PORT intport, UNSIGNED_8 intpin, GPIO_PORT resport, UNSIGNED_8 respin)
{
    UNSIGNED_8 i = 0;
    
    for(i = 0; i < 8; i++)
    {
        ar_ch[i].nr = 0;
        ar_ch[i].dir = INPUT;
        ar_ch[i].interruptenable = FALSE;
        ar_ch[i].pullup = FALSE;
    }
    hndl = DrvI2CRegisterDevice(I2C_CHANNEL_A, MCP23008, 400000, I2C_MASTER);
}
/*--------------------------------------------------------------------------------------------------------------------*/
void StdMCP23008Config(MCP_GPIO gpio)
{
    if(gpio.nr < 8)
    {
        ar_ch[gpio.nr] = gpio;
    }
    //Direction
    reg = REG_IODIR;
    StdMCP23008ReadCmd(&reg, &data);
    
    if(gpio.dir == INPUT)    
    {
        data |= (1 << gpio.nr);
        StdMCP23008WriteCmd(&reg, &data);
        if(gpio.pullup)
        {
            reg = REG_GPPU;
            StdMCP23008ReadCmd(&reg, &data);
            data |= (1 < gpio.nr);
            StdMCP23008WriteCmd(&reg, &data);
        }
        else
        {
            reg = REG_GPPU;
            StdMCP23008ReadCmd(&reg, &data);
            data |= (1 < gpio.nr);
            StdMCP23008WriteCmd(&reg, &data);
        }
    }
    else if(gpio.dir == OUTPUT)
    {
        data &= ~(1 << gpio.nr); 
        StdMCP23008WriteCmd(&reg, &data);
    }
    
    //Interrupt
    reg = REG_GPINTEN;
    StdMCP23008ReadCmd(&reg, &data);
    if(gpio.interruptenable == TRUE)        data |= (1 << gpio.nr);
    else if(gpio.interruptenable == FALSE)  data &= ~(1 << gpio.nr);  
    StdMCP23008WriteCmd(&reg, &data);
}
/*--------------------------------------------------------------------------------------------------------------------*/
BOOLEAN StdMCP23008Set(UNSIGNED_8 ch, BOOLEAN value)
{
    UNSIGNED_8 i = 0;
    
    reg = REG_GPIO;
    StdMCP23008ReadCmd(&reg, &data);
    if(ar_ch[ch].dir == OUTPUT) 
    {
        if(value == TRUE)           data |= (1 << ar_ch[ch].nr);
        else if (value == FALSE)    data &= ~(1 << ar_ch[ch].nr);
    }   
    StdMCP23008WriteCmd(&reg, &data);
    reg = REG_OLAT;
    StdMCP23008ReadCmd(&reg, &data);
    if(((data >> ar_ch[ch].nr) & 0x01) == 0x01) return TRUE;
    else return FALSE;
}
/*--------------------------------------------------------------------------------------------------------------------*/
BOOLEAN StdMCP23008Get(UNSIGNED_8 ch)
{
    reg = REG_GPIO;
    StdMCP23008ReadCmd(&reg, &data);
    if(ar_ch[ch].dir == INPUT)
    {
        if(((data >> ar_ch[ch].nr) & 0x01) == 0x01) return TRUE;
        else return FALSE;
    }
    return FALSE;
}
/*--------------------------------------------------------------------------------------------------------------------*/
void StdMCP23008GetInt(UNSIGNED_8 ch)
{
    UNSIGNED_8 i = 0;
    
    reg = REG_INTCAP;
    StdMCP23008ReadCmd(&reg, &data);
    for(i = 0; i < 8; i++)
    {
        if(((data >> i) & 0x01) == 0x01)
        {
            ar_ch[ch].nr = i;
        }
    }
}
/*--------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/


